<!doctype html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8" />
  <title>Enviro Plus Web</title>
  <meta name="author" content="nophead" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <base href="/" />
  <meta name="keywords" content="Enviro+, EnviroPlus, RaspberryPi" />
  <meta name="description" content="Web interface for Enviro+ sensor board plugged into a Raspberry Pi" />
  <meta name="theme-color" content="#d96500" />
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link rel="stylesheet" href="/static/style.css" media="all" />
</head>

<body>
  <!-- Header -->
  <header class="header">
    <div class="header-title">
      <h1>Enviro Plus Web</h1>
    </div>

    <div class="header-settings">

      <div>
        <span class="header-icon"> 
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" >
            <circle cx="386" cy="210" r="20"/><path d="M432 50h-30V30c0-11.046-4.954-20-16-20s-14.901 9.009-16 20v20h-99V30c0-11.046-4.954-20-16-20s-14.901 9.009-16 20v20h-98V30c0-11.046-4.954-20-16-20s-14.901 9.009-16 20v20H80c-44.112 0-70 25.888-70 70v312c0 44.112 25.888 70 70 70h153c11.046 0 20-2.954 20-14s-8.954-16-20-16H80c-22.056 0-40-17.944-40-40V120c0-22.056 17.944-40 40-40h29v20c0 11.046 4.954 20 16 20s16-8.954 16-20V80h98v20c0 11.046 4.954 20 16 20s16-8.954 16-20V80h99v20c0 11.046 4.954 20 16 20s14.901-9.009 16-20V80h30c22.056 0 40 17.944 40 40v114c0 11.046 4.954 20 16 20s14-8.954 14-20V120c0-44.112-26.018-66.617-70-70zm-41 220c-66.72 0-121 54.28-121 121s54.28 121 121 121 121-54.28 121-121-54.28-121-121-121zm0 212c-44.663 0-91-46.336-91-91s46.337-91 91-91 91 46.336 91 91-46.337 91-91 91zm25-107h-9v-25c0-11.046-4.954-20-16-20s-16 8.954-16 20v39c0 11.046 4.954 18 16 18h29c11.046 0 20-4.954 20-16s-12.954-16-24-16z"/><circle cx="299" cy="210" r="20"/><circle cx="212" cy="297" r="20"/><circle cx="125" cy="210" r="20"/><circle cx="125" cy="297" r="20"/><circle cx="125" cy="384" r="20"/><circle cx="212" cy="384" r="20"/><circle cx="212" cy="210" r="20"/>
          </svg>
        </span>
        <select id="graph-sel">
          <option value="5min">5 minutes</option>
          <option value="day">1 day</option>
          <option value="week">1 week</option>
          <option value="month">1 month</option>
          <option value="year">1 year</option>
        </select>
      </div>

      <div>
        <span class="header-icon">
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512">
            <use xlink:href="#B"/><use xlink:href="#B" y="412"/><path d="M50 60c5.52 0 10-4.48 10-10s-4.48-10-10-10-10 4.48-10 10 4.48 10 10 10zm0 0"/><use xlink:href="#B" x="-412" y="412"/><path d="M455.452 8.137H56.548c-26.694 0-48.411 21.717-48.411 48.411v398.904c0 26.694 21.717 48.411 48.411 48.411h398.904c26.694 0 48.411-21.717 48.411-48.411V56.548c0-26.694-21.717-48.411-48.411-48.411zm29.046 447.315c0 16.017-13.029 29.046-29.046 29.046H56.548c-16.017 0-29.046-13.029-29.046-29.046V56.548c0-16.017 13.029-29.046 29.046-29.046h398.904c16.017 0 29.046 13.029 29.046 29.046zM366 176c0-49.625-40.375-90-90-90h-20a10 10 0 0 0-10 10v83.391C229.316 158.777 203.879 146 176 146c-49.625 0-90 40.375-90 90v20c0 5.523 4.477 9.988 10 9.988h83.391C158.777 282.676 146 308.121 146 336c0 49.625 40.375 90 90 90h20a10 10 0 0 0 10-10v-83.391C282.684 353.223 308.121 366 336 366c49.625 0 90-40.375 90-90v-20a10 10 0 0 0-10-10h-83.391C353.223 229.316 366 203.879 366 176zm-90-70c38.598 0 70 31.402 70 70 0 28.402-17.035 53.551-42.504 64.391-5.566-16.922-19.91-29.785-37.496-33.375V106zm-18.098 179.938c-16.969 1.023-30.848-11.926-31.84-28.035C225.008 240.406 238.867 226 256 226c16.418 0 30 13.316 30 30 0 15.816-12.352 28.969-28.098 29.938zM106 236c0-38.598 31.402-70 70-70 28.402 0 53.551 17.035 64.391 42.504-16.922 5.566-29.785 19.91-33.375 37.496H106zm130 170c-38.598 0-70-31.402-70-70 0-28.402 17.035-53.551 42.504-64.391 5.566 16.922 19.91 29.785 37.496 33.375V406zm170-130c0 38.598-31.402 70-70 70-28.402 0-53.551-17.035-64.391-42.504 16.922-5.566 29.785-19.91 33.375-37.496H406zm0 0"/><circle cx="257.201" cy="257.229" r="207.024" fill="none" stroke-width="18" stroke="#000"/><defs ><path id="B" d="M462 40c-5.52 0-10 4.48-10 10s4.48 10 10 10 10-4.48 10-10-4.48-10-10-10zm0 0"/></defs>
          </svg>
        </span>
        <input id="fan" type="number" min="0" max="100" step="5" value="100" size="3" name="fan">
      </div>

      <div>
        <a href="https://github.com/nophead/EnviroPlusWeb" class="header-icon" target="_blank" title="Enviro Plus Web source code at GitHub" rel="noopener noreferrer">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
            <path d="M255.968 5.329C114.624 5.329 0 120.401 0 262.353c0 113.536 73.344 209.856 175.104 243.872 12.8 2.368 17.472-5.568 17.472-12.384l-.352-43.712c-71.2 15.52-86.24-34.464-86.24-34.464-11.616-29.696-28.416-37.6-28.416-37.6-23.264-15.936 1.728-15.616 1.728-15.616 25.696 1.824 39.2 26.496 39.2 26.496 22.848 39.264 59.936 27.936 74.528 21.344 2.304-16.608 8.928-27.936 16.256-34.368-56.832-6.496-116.608-28.544-116.608-127.008 0-28.064 9.984-51.008 26.368-68.992-2.656-6.496-11.424-32.64 2.496-68 0 0 21.504-6.912 70.4 26.336 20.416-5.696 42.304-8.544 64.096-8.64 21.728.128 43.648 2.944 64.096 8.672 48.864-33.248 70.336-26.336 70.336-26.336 13.952 35.392 5.184 61.504 2.56 68 16.416 17.984 26.304 40.928 26.304 68.992 0 98.72-59.84 120.448-116.864 126.816 9.184 7.936 17.376 23.616 17.376 47.584l-.32 70.496c0 6.88 4.608 14.88 17.6 12.352C438.72 472.145 512 375.857 512 262.353 512 120.401 397.376 5.329 255.968 5.329z"/>
          </svg>
        </a>
      </div>

    </div>
  </header>

  <!-- Main content -->
  <main class="main">
    <div class="container-readings">
      <span id="readings">---</span>
    </div>

    <div class="container-graph">
      <canvas id="canvas" height="400" width="600"></canvas>
      <br><br>
      <table style="width:600px">
        <tr id="legend"></tr>
        <tr id="range"></tr>
      </table>
    </div>

  </main>

  <!-- Footer -->
  <footer class="footer">

  </footer>

  <script>
    setInterval(function () {
      // Call a function repetitively with 1 second interval
      getData();
      getGraph();
    }, 900); //~1s update rate

    var frequencies = {
      '5min': { major: 300, minor: 60, poll: 1 },
      'day': { major: 3 * 3600, minor: 3600, poll: 60 },
      'week': { major: 24 * 3600, minor: 6 * 3600, poll: 600 },
      'month': { major: 7 * 24 * 3600, minor: 24 * 3600, poll: 1440 },
      'year': { major: 31 * 24 * 3600, minor: 7 * 24 * 3600, poll: 17280 }
    };

    var particle_sensor = false;
    var gas_sensor = false;

    function getData() {
      var xhttp = new XMLHttpRequest();
      var fan = document.getElementById("fan").value;
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          document.getElementById("readings").innerHTML = this.responseText;
          particle_sensor = this.responseText.search("10.0um") > 0;
          gas_sensor = this.responseText.search("Oxidising") > 0;
        }
      };
      xhttp.open("GET", "readings?fan=" + fan, true);
      xhttp.send();
    }

    var last_frequency = "";
    var last_graph = 0;
    function getGraph() {
      var frequency = document.getElementById("graph-sel").value;
      var t = Date.now() / 1000;
      if (frequency != last_frequency || t - last_graph >= frequencies[frequency].poll) {
        last_frequency = frequency;
        last_graph = t;
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            graph(JSON.parse(this.responseText));
          }
        };
        xhttp.open("GET", "graph?time=" + frequency, true);
        xhttp.send();
      }
    }

    var items_ngp = [
      { name: "temp", colour: "#FF0000", min: 0, max: 50 },
      { name: "humi", colour: "#0000FF", min: 0, max: 100 },
      { name: "pres", colour: "green", min: 950, max: 1050 },
      { name: "lux", colour: "#FFFF00", min: 0, max: 25000 },
    ]

    var items_g = [
      { name: "oxi", colour: "#00FFFF", min: 0, max: 400 },
      { name: "red", colour: "darkorange", min: 0, max: 1000 },
      { name: "nh3", colour: "#FF00FF", min: 0, max: 600 },
    ]

    var items_p = [
      { name: "pm03", colour: "#000000", min: 0, max: 20000 },
      { name: "pm05", colour: "#181818", min: 0, max: 10000 },
      { name: "pm10", colour: "#303030", min: 0, max: 2000 },
      { name: "pm25", colour: "#505050", min: 0, max: 500 },
      { name: "pm50", colour: "#707070", min: 0, max: 200 },
      { name: "pm100", colour: "#909090", min: 0, max: 100 },
    ];

    var canvas;
    var ctx;
    var data;
    var yScaleSteps = 10;
    var yLabelHeight = 10;
    var xLabelHeight = 10;
    var xScale;
    var yScale;
    var yLabelWidth = 25;
    function graph(d) {
      data = d;
      canvas = document.getElementById("canvas");
      ctx = canvas.getContext("2d");
      ctx.fillStyle = "#0099ff"
      ctx.font = "20 pt Verdana"

      yScale = (canvas.height - yLabelHeight - xLabelHeight);
      xScale = (canvas.width - yLabelWidth) / (data.length - 1);

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      // Print X axis vertical time lines
      var frequency = document.getElementById("graph-sel").value;
      var major = frequencies[frequency].major;
      var minor = frequencies[frequency].minor;
      var show_date = major >= 24 * 3600;
      var months = {
        'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
        'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11
      }
      ctx.textAlign = 'center';
      for (var i = 0; i < data.length; i++) {
        var fields = data[i]['time'].match(/\S+/g); // split is broken!
        var t = fields[3].split(':');
        var date = months[fields[1]] * 31 + parseInt(fields[2]) - 1;
        var time = date * 24 * 3600 + parseInt(t[0]) * 3600 + parseInt(t[1]) * 60 + parseInt(t[2]);
        if (time % minor == 0) {
          var is_major = (time % major) == 0;
          var x = i * xScale + yLabelWidth;
          if (is_major)
            ctx.fillText(show_date ? fields[0] + ' ' + fields[1] + ' ' + fields[2]
              : fields[3].slice(0, 5), x, canvas.height);
          ctx.beginPath();
          ctx.strokeStyle = is_major ? "#808080" : "#B0B0B0"; // colour of grid lines
          ctx.moveTo(x, 0);
          ctx.lineTo(x, canvas.height - xLabelHeight);
          ctx.stroke();
        }
      }

      // Print Y axis labels and draw horizontal grid lines
      ctx.beginPath();
      ctx.strokeStyle = "#B0B0B0"; // colour of grid lines
      ctx.textAlign = 'left';
      for (var i = 0; i <= yScaleSteps; i++) {
        var y = yScale * (yScaleSteps - i) / yScaleSteps + yLabelHeight - 1;
        ctx.fillText(i / yScaleSteps, yLabelHeight, y);
        ctx.moveTo(yLabelWidth, y)
        ctx.lineTo(canvas.width, y)
      }
      ctx.stroke();

      // Plot each item
      var keys = "";
      var ranges = "";
      var items = particle_sensor ? items_ngp.concat(items_g).concat(items_p) :
        gas_sensor ? items_ngp.concat(items_g) : items_ngp;
      for (var item of items) {
        ctx.strokeStyle = item.colour;
        plotData(item.name, item.min, item.max);
        keys += '<td style="color:' + item.colour + '"> ' + item.name + ' </td>';
        ranges += '<td>/' + (item.max - item.min) + '</td>';
      }
      // Update the legend
      document.getElementById("legend").innerHTML = keys;
      document.getElementById("range").innerHTML = ranges;
    }

    function scaley(y, min, max) {
      return (y - min) * yScale / (max - min);
    }

    function plotData(dataSet, min, max) {
      ctx.beginPath();
      y0 = canvas.height - xLabelHeight;
      ctx.moveTo(yLabelWidth, y0 - scaley(data[0][dataSet], min, max));
      for (var i = 1; i < data.length; i++)
        ctx.lineTo(yLabelWidth + i * xScale, y0 - scaley(data[i][dataSet], min, max));

      ctx.stroke();
    }

  </script>

</body>

</html>